<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>O Estrangeiro Temporal</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Cinzel+Decorative:wght@400;700&family=Merriweather:ital,wght@0,400;0,700;1,400&display=swap');
        
        :root {
            --color-dark: #0A0A0A;
            --color-parchment: #1E1D1B;
            --color-blood-dark: #3A0000;
            --color-blood-light: #7A0000;
            --color-accent: #B0A090;
            --color-gold: #C0A080;
            --font-title: 'Cinzel Decorative', serif;
            --font-body: 'Merriweather', serif;
        }

        @keyframes subtle-glow {
            0% { filter: brightness(100%); }
            50% { filter: brightness(105%); }
            100% { filter: brightness(100%); }
        }

        @keyframes write-bounce {
            0%, 100% { transform: translateY(0) rotate(5deg); }
            50% { transform: translateY(-5px) rotate(-5deg); }
        }
        
        @keyframes skull-pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        body {
            font-family: var(--font-body);
            background-color: var(--color-dark);
            background-image: url('https://upload.wikimedia.org/wikipedia/commons/4/41/Thomas_Eakins%2C_American_-_Portrait_of_Dr._Samuel_D._Gross_%28The_Gross_Clinic%29_-_Google_Art_Project.jpg');
            background-size: cover;
            background-attachment: fixed;
            background-position: center;
            color: #D0D0D0;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            padding: 20px;
            box-sizing: border-box;
            animation: subtle-glow 15s infinite alternate ease-in-out;
        }
        
        .game-container {
            width: 100%;
            max-width: 800px;
            background-color: rgba(30,29,27,0.92);
            border-radius: 5px;
            box-shadow: 0 0 30px rgba(122, 0, 0, 0.5);
            border: 1px solid var(--color-gold);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            backdrop-filter: blur(5px);
            border-top: 1px solid rgba(192, 160, 128, 0.3);
            border-left: 1px solid rgba(192, 160, 128, 0.3);
        }

        .header {
            text-align: center;
            padding: 20px;
            border-bottom: 3px solid var(--color-blood-dark);
        }
        
        .header h1 {
            font-family: var(--font-title);
            margin: 0;
            font-size: 3rem;
            color: var(--color-gold);
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.8);
            letter-spacing: 2px;
            font-weight: 400;
            border-bottom: 1px solid rgba(192, 160, 128, 0.3);
            padding-bottom: 10px;
        }

        @media (min-width: 768px) {
            .header h1 {
                font-size: 4rem;
            }
        }
        
        .attributes-bar {
            display: flex;
            justify-content: space-around;
            padding: 10px 20px;
            background-color: rgba(0,0,0,0.3);
            border-bottom: 1px solid var(--color-blood-dark);
        }
        .attribute {
            font-family: var(--font-body);
            font-size: 1em;
            color: var(--color-accent);
            text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
        }
        .attribute-value {
            font-weight: bold;
            color: var(--color-gold);
        }

        .story-box {
            height: 500px;
            overflow-y: auto;
            padding: 20px;
            white-space: pre-wrap;
            line-height: 1.6;
            font-size: 1.1em;
            font-style: italic;
            scrollbar-width: thin;
            scrollbar-color: var(--color-blood-dark) var(--color-parchment);
            scroll-behavior: smooth;
            box-shadow: inset 0 0 15px rgba(0, 0, 0, 0.8);
        }
        .story-box::-webkit-scrollbar {
            width: 8px;
        }
        .story-box::-webkit-scrollbar-thumb {
            background-color: var(--color-blood-dark);
            border-radius: 4px;
        }
        .story-box::-webkit-scrollbar-track {
            background-color: var(--color-parchment);
        }
        .message {
            margin-bottom: 15px;
            padding: 10px;
            border-radius: 8px;
            transition: all 0.3s ease;
        }
        .message.bot {
            background-color: rgba(10,10,10,0.7);
            border-left: 2px solid var(--color-gold);
            position: relative;
        }
        .message.bot::before {
            content: "";
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 2px;
            background: linear-gradient(to bottom, var(--color-gold), transparent);
        }
        .message.player {
            background-color: rgba(30,29,27,0.7);
            text-align: right;
            border-right: 2px solid var(--color-accent);
            position: relative;
        }
        .message.player::after {
            content: "";
            position: absolute;
            right: 0;
            top: 0;
            bottom: 0;
            width: 2px;
            background: linear-gradient(to bottom, var(--color-accent), transparent);
        }
        .input-area {
            display: flex;
            padding: 20px;
            border-top: 3px solid var(--color-blood-dark);
            gap: 10px;
        }
        .input-area textarea {
            flex-grow: 1;
            padding: 12px;
            border-radius: 12px;
            border: 2px solid var(--color-blood-dark);
            background-color: rgba(0,0,0,0.4);
            color: #e0e0e0;
            font-family: var(--font-body);
            resize: none;
            outline: none;
            transition: border-color 0.3s, box-shadow 0.3s;
            box-shadow: inset 0 0 8px rgba(0, 0, 0, 0.6);
        }
        .input-area textarea:focus {
            border-color: var(--color-blood-light);
            box-shadow: 0 0 10px var(--color-blood-light);
        }
        .controls {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .controls button {
            background: linear-gradient(145deg, rgba(122,0,0,0.7), rgba(58,0,0,0.7));
            color: var(--color-gold);
            border: 1px solid var(--color-gold);
            padding: 12px 20px;
            border-radius: 3px;
            font-weight: normal;
            cursor: pointer;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.8);
            box-shadow: 0 0 10px rgba(122, 0, 0, 0.3);
            transition: all 0.3s;
            font-family: var(--font-body);
            letter-spacing: 1px;
        }
        .controls button:hover {
            background: linear-gradient(145deg, rgba(122,0,0,0.9), rgba(58,0,0,0.9));
            transform: translateY(-2px);
            box-shadow: 0 0 15px rgba(122, 0, 0, 0.5);
            color: #FFF;
        }
        .controls button:disabled {
            background: #555;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        .loading-indicator {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-top: 10px;
            color: var(--color-accent);
            font-style: italic;
        }
        .loading-indicator p {
            margin: 0;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5);
        }
        .skull-icon {
            font-size: 2em;
            animation: skull-pulse 1.5s infinite;
            margin-bottom: 5px;
        }
        .status-bar {
            padding: 10px 20px;
            font-size: 0.8em;
            text-align: center;
            background-color: rgba(0,0,0,0.3);
            border-top: 1px solid var(--color-blood-dark);
        }
        .status-bar span {
            color: var(--color-accent);
            font-weight: bold;
        }
        @media (max-width: 600px) {
            .input-area {
                flex-direction: column;
            }
            .controls {
                flex-direction: row;
                justify-content: space-around;
            }
        }
    </style>
</head>
<body>

<div class="game-container">
    <div class="header">
        <h1>O Estrangeiro Temporal</h1>
        <p>Um romance g√≥tico de tempos cruzados</p>
    </div>
    
    <div class="attributes-bar">
        <div class="attribute">Sa√∫de: <span id="healthDisplay" class="attribute-value">100</span></div>
        <div class="attribute">Sanidade: <span id="sanityDisplay" class="attribute-value">100</span></div>
    </div>

    <div class="story-box" id="storyBox">
        <div class="message bot">
            <p>Carregando aventura...</p>
        </div>
    </div>
    <div class="loading-indicator" id="loadingIndicator" style="display:none;">
        <span class="skull-icon">üíÄ</span>
        <p id="loadingText">O destino est√° sendo escrito...</p>
    </div>
    <div class="input-area">
        <textarea id="playerInput" placeholder="Digite sua a√ß√£o..."></textarea>
        <div class="controls">
            <button id="sendBtn">Enviar</button>
            <button id="saveBtn">Salvar Jogo</button>
        </div>
    </div>
    <div class="status-bar">
        Seu ID de Usu√°rio: <span id="userIdDisplay">Carregando...</span>
    </div>
</div>

<script type="module">
    // Firebase Imports
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, getDoc, setDoc, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // --- Vari√°veis Globais (N√£o modifique) ---
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
    const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
    const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
    
    // --- Refer√™ncias UI ---
    const storyBox = document.getElementById('storyBox');
    const playerInput = document.getElementById('playerInput');
    const sendBtn = document.getElementById('sendBtn');
    const saveBtn = document.getElementById('saveBtn');
    const loadingIndicator = document.getElementById('loadingIndicator');
    const loadingTextElement = document.getElementById('loadingText');
    const userIdDisplay = document.getElementById('userIdDisplay');
    const healthDisplay = document.getElementById('healthDisplay');
    const sanityDisplay = document.getElementById('sanityDisplay');

    // --- Vari√°veis de Estado ---
    let db;
    let auth;
    let userId;
    let isAuthReady = false;
    let loadingInterval;
    const loadingTexts = [
        "O destino est√° sendo escrito...",
        "O passado est√° se revelando...",
        "A morte est√° √† espreita...",
        "Calculando a pr√≥xima cena...",
        "Decifrando os mist√©rios..."
    ];

    // Estado do jogo (serializ√°vel para salvar)
    let gameState = {
        story: [],
        playerData: {
            name: "Jovem Brasileiro",
            age: 20,
            year: 2025,
            currentLocation: "Sala de disseca√ß√£o",
            saude: 100,
            sanidade: 100
        },
        characters: {
            "jane": {
                nome: "Jane",
                relacao: "Estranha, mas curiosa",
                descricao: "Uma jovem de cabelos escuros e olhos expressivos, sentada em um banco na sala de aula. Ela parece notar sua presen√ßa de uma forma estranha.",
                sentimento_pelo_jogador: "Curiosidade misturada com cautela."
            }
        }
    };

    // --- Fun√ß√µes do Jogo ---

    // Adiciona uma mensagem ao log da hist√≥ria
    function addMessage(text, sender) {
        const messageDiv = document.createElement('div');
        messageDiv.classList.add('message', sender);
        messageDiv.innerHTML = `<p>${text}</p>`;
        storyBox.appendChild(messageDiv);
        storyBox.scrollTop = storyBox.scrollHeight;
    }

    // Atualiza a exibi√ß√£o dos atributos do jogador na UI
    function updateAttributesUI() {
        healthDisplay.textContent = gameState.playerData.saude;
        sanityDisplay.textContent = gameState.playerData.sanidade;
    }

    // Constr√≥i o prompt para a IA, incluindo o formato de resposta desejado
    function buildPrompt(playerAction) {
        const history = gameState.story.slice(-5); // Pega as √∫ltimas 5 intera√ß√µes para contexto
        const recentEvents = history.map(turn => {
            return `Jogador: ${turn.playerAction}\nMestre: ${turn.botResponse}`;
        }).join('\n\n');

        const characterDetails = Object.keys(gameState.characters).map(key => {
            const char = gameState.characters[key];
            return `Nome: ${char.nome}\nRela√ß√£o com o protagonista: ${char.relacao}\nDescri√ß√£o: ${char.descricao}\nSentimento: ${char.sentimento_pelo_jogador}`;
        }).join('\n\n');

        // O prompt detalhado agora inclui as instru√ß√µes para a resposta JSON
        const prompt = `
            Voc√™ √© o Mestre de um RPG de texto. Sua persona √© um autor de romance g√≥tico do s√©culo XIX. A narrativa √© po√©tica, atmosf√©rica, com toques de melancolia, paix√£o e mist√©rio.

            O protagonista √© um jovem brasileiro de 20 anos, vindo do ano de 2025, que acordou inexplicavelmente em uma sala de disseca√ß√£o nos Estados Unidos, no s√©culo XIX. O cen√°rio √© a sala do Dr. Samuel D. Gross, com um cad√°ver sobre a mesa e alunos ao redor. Ele veste roupas modernas, mas ningu√©m parece notar.

            Seu estilo de narra√ß√£o deve evocar o clima de um romance cl√°ssico. Inclua detalhes hist√≥ricos sobre ambientes, roupas, odores, ilumina√ß√£o e costumes.

            Atributos do protagonista:
            Sa√∫de: ${gameState.playerData.saude}
            Sanidade: ${gameState.playerData.sanidade}

            Detalhes de personagens:
            ${characterDetails}

            Resumo dos eventos recentes:
            ${recentEvents || 'O jogo acabou de come√ßar. O protagonista acabou de acordar em choque na sala de disseca√ß√£o.'}

            A√ß√£o do jogador: ${playerAction}

            SUA RESPOSTA DEVE SER APENAS UM OBJETO JSON. NADA MAIS. O FORMATO DEVE SER:
            {
                "narrativa": "Sua resposta narrativa aqui...",
                "mudancas_estado": {
                    "saude": <valor_a_somar_ou_subtrair>,
                    "sanidade": <valor_a_somar_ou_subtrair>
                }
            }
            A "narrativa" √© o texto da hist√≥ria. Em "mudancas_estado", inclua apenas os atributos que voc√™ deseja mudar. Use valores positivos para aumentar e negativos para diminuir.
            
            Exemplo: Se a a√ß√£o do jogador for perigosa, voc√™ pode responder com:
            {
                "narrativa": "A tentativa falha miseravelmente, e voc√™ trope√ßa no cad√°ver, sentindo uma dor aguda na perna.",
                "mudancas_estado": {
                    "saude": -10,
                    "sanidade": -5
                }
            }
            Agora, o que acontece?
        `;
        return prompt;
    }

    // Faz a chamada para a API da Mistral e processa a resposta JSON
    async function getMistralResponse(prompt) {
        loadingIndicator.style.display = 'flex';
        let textIndex = 0;
        loadingInterval = setInterval(() => {
            textIndex = (textIndex + 1) % loadingTexts.length;
            loadingTextElement.textContent = loadingTexts[textIndex];
        }, 1000);
        
        const mistralApiKey = 'S3DyvxfJDguSNqHSlqkJrzwZEbVqo8qb'; 
        const mistralApiUrl = 'https://api.mistral.ai/v1/chat/completions'; 

        try {
            const payload = {
                model: 'mistral-large-latest', 
                messages: [{ role: 'user', content: prompt }],
                temperature: 0.7,
                max_tokens: 500,
                response_format: { type: "json_object" }
            };

            const response = await fetch(mistralApiUrl, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${mistralApiKey}`,
                },
                body: JSON.stringify(payload)
            });

            if (!response.ok) {
                throw new Error(`Erro da API: ${response.status} ${response.statusText}`);
            }

            const data = await response.json();
            const botResponseText = data.choices[0].message.content;

            clearInterval(loadingInterval);
            loadingIndicator.style.display = 'none';

            // Tenta analisar o JSON
            try {
                const botResponse = JSON.parse(botResponseText);
                return botResponse;
            } catch (jsonError) {
                console.error("Erro ao analisar a resposta JSON da IA:", jsonError);
                return {
                    narrativa: "Ocorreu um erro ao processar a resposta. Tente novamente.",
                    mudancas_estado: {}
                };
            }

        } catch (error) {
            console.error("Erro ao comunicar com a API da Mistral:", error);
            clearInterval(loadingInterval);
            loadingIndicator.style.display = 'none';
            return {
                narrativa: "Ocorreu um erro ao conectar com o passado. Tente novamente mais tarde.",
                mudancas_estado: {}
            };
        }
    }

    // Envia a a√ß√£o do jogador para a IA e atualiza o jogo
    async function sendMessage() {
        const playerAction = playerInput.value.trim();
        if (!playerAction) return;

        addMessage(playerAction, 'player');
        playerInput.value = '';
        sendBtn.disabled = true;

        try {
            const prompt = buildPrompt(playerAction);
            const botResponse = await getMistralResponse(prompt);
            
            const narrative = botResponse.narrativa || "A resposta da IA est√° vazia.";
            const changes = botResponse.mudancas_estado || {};

            // Aplica as mudan√ßas de estado
            if (changes.saude) {
                gameState.playerData.saude = Math.max(0, Math.min(100, gameState.playerData.saude + changes.saude));
            }
            if (changes.sanidade) {
                gameState.playerData.sanidade = Math.max(0, Math.min(100, gameState.playerData.sanidade + changes.sanidade));
            }
            updateAttributesUI();

            gameState.story.push({
                playerAction: playerAction,
                botResponse: narrative
            });

            addMessage(narrative, 'bot');
            await saveGame();
        } catch (error) {
            addMessage("Ocorreu um erro. Tente novamente mais tarde.", 'bot');
            console.error("Erro ao comunicar com a IA:", error);
        } finally {
            sendBtn.disabled = false;
        }
    }

    // Salva o estado do jogo no Firestore
    async function saveGame() {
        if (!isAuthReady || !userId) return;
        try {
            const gameRef = doc(db, `artifacts/${appId}/users/${userId}/rpg_game/save_data`);
            const serializableData = JSON.stringify(gameState);
            await setDoc(gameRef, { data: serializableData });
            console.log("Jogo salvo com sucesso!");
        } catch (e) {
            console.error("Erro ao salvar o documento: ", e);
        }
    }

    // Carrega o estado do jogo do Firestore
    async function loadGame() {
        if (!isAuthReady || !userId) return;
        try {
            const gameRef = doc(db, `artifacts/${appId}/users/${userId}/rpg_game/save_data`);
            const gameSnap = await getDoc(gameRef);

            if (gameSnap.exists() && gameSnap.data().data) {
                const loadedData = JSON.parse(gameSnap.data().data);
                gameState = loadedData;
                renderStory();
                updateAttributesUI();
                addMessage("Jogo anterior carregado! Continue sua aventura.", 'bot');
            } else {
                console.log("Nenhum jogo salvo encontrado. Iniciando nova aventura.");
                const initialText = "Voc√™ acorda de um torpor. Uma dor aguda na nuca o faz piscar, e o cheiro forte de formalde√≠do e sangue invade suas narinas. Emba√ßado, voc√™ v√™ a cena: um cad√°ver sobre uma mesa, um homem de barbas longas e alguns alunos o observando. Uma aula de anatomia? O que est√° acontecendo?";
                gameState.story = [{ playerAction: "", botResponse: initialText }];
                renderStory();
                updateAttributesUI();
            }
        } catch (e) {
            console.error("Erro ao carregar o jogo: ", e);
            addMessage("Ocorreu um erro ao carregar o jogo. Iniciando uma nova aventura.", 'bot');
            gameState.story = [{ playerAction: "", botResponse: "Ocorreu um erro ao carregar o jogo. Iniciando uma nova aventura." }];
            renderStory();
            updateAttributesUI();
        }
    }

    // Renderiza a hist√≥ria a partir do estado do jogo
    function renderStory() {
        storyBox.innerHTML = '';
        gameState.story.forEach(turn => {
            if (turn.playerAction) {
                addMessage(turn.playerAction, 'player');
            }
            if (turn.botResponse) {
                addMessage(turn.botResponse, 'bot');
            }
        });
    }

    // --- Inicializa√ß√£o ---
    async function init() {
        try {
            if (!firebaseConfig) {
                throw new Error("Configura√ß√£o do Firebase n√£o encontrada. O aplicativo n√£o pode ser inicializado.");
            }
            
            setLogLevel('debug');
            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);

            if (initialAuthToken) {
                await signInWithCustomToken(auth, initialAuthToken);
            } else {
                await signInAnonymously(auth);
            }

            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    userId = user.uid;
                    userIdDisplay.textContent = userId;
                    isAuthReady = true;
                    await loadGame();
                } else {
                    console.log("Usu√°rio n√£o autenticado.");
                }
            });

            // Adiciona listeners para os bot√µes
            sendBtn.addEventListener('click', sendMessage);
            saveBtn.addEventListener('click', saveGame);
            playerInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });

        } catch (error) {
            console.error("Falha na inicializa√ß√£o do aplicativo:", error);
            const errorMessage = "Erro cr√≠tico ao inicializar o aplicativo. Por favor, verifique a conex√£o e tente novamente.";
            addMessage(errorMessage, 'bot');
        }
    }

    init();
</script>

</body>
</html>
